<?php

// Compression level for PNG mockups generated by convert_webp_to_png_server().
// 0 = no compression, 9 = maximum compression.
// Higher values produce smaller files but require more CPU time.
if (!defined('PNG_COMPRESSION_LEVEL')) {
    define('PNG_COMPRESSION_LEVEL', 8);
}

// Maximum width or height for PNG mockups generated for Printful.
// Images larger than this size are downscaled before saving.
if (!defined('MOCKUP_MAX_DIMENSION')) {
    define('MOCKUP_MAX_DIMENSION', 1500);
}

function customiizer_log($message) {
        $log_file = __DIR__ . '/customiizer.log';
        $date = date('Y-m-d H:i:s');
        $line = "[$date] $message\n";
        file_put_contents($log_file, $line, FILE_APPEND);
}

function printful_apply_rate_limit(array $headers): void {
        $lower = [];
        foreach ($headers as $k => $v) {
                $lower[strtolower($k)] = is_array($v) ? implode(',', $v) : $v;
        }

        $remaining = isset($lower['x-ratelimit-remaining'])
                ? (int) $lower['x-ratelimit-remaining']
                : null;
        $reset = isset($lower['x-ratelimit-reset'])
                ? (int) $lower['x-ratelimit-reset']
                : null;

        if ($remaining !== null || $reset !== null) {
                customiizer_log("🪙 RateLimit remaining={$remaining} reset={$reset}");
        }

        if ($remaining !== null && $reset !== null && $remaining <= 1) {
                customiizer_log("⏳ Waiting {$reset}s due to Printful rate limit");
                sleep($reset);
        }
}
